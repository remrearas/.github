name: Generate Intro Animation                                                                                                                                                         
                                                                                                                                                                                       
on:                                                                                                                                                                                    
  workflow_dispatch:                                                                                                                                                                   
    inputs:                                                                                                                                                                            
      prefix:                                                                                                                                                                          
        description: 'Output filename: intro-<prefix>.gif'                                                                                                                             
        required: true                                                                                                                                                                 
        default: 'dark'
        type: string
      theme:
        description: 'agg color theme'
        required: true
        default: 'solarized-dark'
        type: choice
        options:
          - solarized-dark
          - solarized-light
          - monokai
          - dracula
          - github-dark
          - github-light
          - nord
          - gruvbox-dark
          - gruvbox-light

jobs:
  generate:
    runs-on: self-hosted

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Record animation
        run: |
          export TERM=xterm-256color
          chmod +x scripts/workspace-intro.sh

          asciinema rec \
            --cols 120 \
            --rows 24 \
            --idle-time-limit 2 \
            -c "./scripts/workspace-intro.sh" \
            recording.cast

      - name: Convert to GIF
        env:
          AGG_THEME: ${{ inputs.theme }}
          OUTPUT_PREFIX: ${{ inputs.prefix }}
        run: |
          mkdir -p assets

          docker run --rm \
            -v "$(pwd)":/data \
            -v "/home/runner/.local/share/fonts":/fonts:ro \
            agg:latest \
            --font-dir /fonts \
            --speed 1.5 \
            --fps-cap 15 \
            --theme "$AGG_THEME" \
            --last-frame-duration 3 \
            /data/recording.cast \
            "/data/assets/intro-${OUTPUT_PREFIX}.gif"

      - name: Commit
        env:
          OUTPUT_PREFIX: ${{ inputs.prefix }}
        run: |
          rm -f recording.cast

          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add "assets/intro-${OUTPUT_PREFIX}.gif"
          git diff --staged --quiet || git commit -m "chore: update intro animation (${OUTPUT_PREFIX})"
          git pull --rebase
          git push

