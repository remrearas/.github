name: Generate Intro Animation

on:
  workflow_dispatch:

env:
  AGG_THEME: github-dark

jobs:
  generate:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup runner dependencies
        run: |
          chmod +x .github/main/scripts/runner.sh
          sudo .github/main/scripts/runner.sh

      - name: Record animation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          export TERM=xterm-256color
          chmod +x scripts/workspace-intro.sh

          asciinema rec \
            --cols 120 \
            --rows 24 \
            --idle-time-limit 2 \
            -c "./scripts/workspace-intro.sh" \
            recording.cast

      - name: Convert to GIF
        run: |
          mkdir -p assets

          docker run --rm \
            -v "$(pwd)":/data \
            -v "/usr/share/fonts":/fonts:ro \
            agg:latest \
            --font-dir /fonts \
            --speed 1.5 \
            --fps-cap 15 \
            --theme "$AGG_THEME" \
            --last-frame-duration 3 \
            /data/recording.cast \
            /data/assets/intro.gif

      - name: Commit
        run: |
          rm -f recording.cast

          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add assets/intro.gif
          git diff --staged --quiet || git commit -m "chore: update intro animation"
          git checkout -- .
          git clean -fd
          git pull --rebase
          git push
